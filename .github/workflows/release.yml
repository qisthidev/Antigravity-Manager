name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
          - platform: "macos-latest"
            args: "--target universal-apple-darwin"
          - platform: "ubuntu-22.04"
            args: ""
          - platform: "ubuntu-24.04-arm"
            args: ""
          - platform: "windows-latest"
            args: ""

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev patchelf pkg-config libsoup-3.0-dev javascriptcoregtk-4.1 libjavascriptcoregtk-4.1-dev
          sudo apt-get install -y libnm-dev xdg-utils

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || (contains(matrix.args, 'aarch64') && 'aarch64-unknown-linux-gnu' || '') }}

      - name: Node.js setup
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install frontend dependencies
        run: npm install

      - name: Build the app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- ${{ matrix.args }}

      # 1. 生成 updater.json 碎片 (Tauri v2 默认不产出包含下载链接的 JSON)
      - name: Generate updater fragment
        if: matrix.platform == 'macos-latest' || matrix.platform == 'windows-latest'
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_CLEAN=$(echo $VERSION | sed 's/^v//')
          
          # 1. 确定架构标识
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            if [[ "${{ matrix.args }}" == *"--target aarch64-apple-darwin"* ]]; then
              ARCH="darwin-aarch64"
            elif [[ "${{ matrix.args }}" == *"--target x86_64-apple-darwin"* ]]; then
              ARCH="darwin-x86_64"
            elif [[ "${{ matrix.args }}" == *"--target universal-apple-darwin"* ]]; then
              ARCH="darwin-universal"
            else
              # 自动检测构建出的目录名
              ARCH_DIR=$(ls src-tauri/target/ | grep -E "aarch64|x86_64|universal" | head -n 1)
              if [[ "$ARCH_DIR" == *"aarch64"* ]]; then ARCH="darwin-aarch64";
              elif [[ "$ARCH_DIR" == *"x86_64"* ]]; then ARCH="darwin-x86_64";
              else ARCH="darwin-universal"; fi
            fi
          else
            ARCH="windows-x86_64"
          fi
          echo "Detected architecture: $ARCH"

          # 2. 调试：列出产物目录
          echo "Debug: Searching for bundles in whole repository..."
          # 3. 寻找安装包 (Tauri v2)
          # 激进搜索策略：从根目录搜索所有常见的包格式，确保在任何 target 结构下都能找到
          ALL_CANDIDATES=$(find . -type f \( -name "*.app.tar.gz" -o -name "*.zip" -o -name "*.msi" -o -name "*.tar.gz" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" \) -not -path "*/node_modules/*")
          echo "All potential candidates found across repository:"
          echo "$ALL_CANDIDATES"
          
          # 优先匹配特定的更新包格式 (Updater 专用)
          BUNDLE_PATH=$(echo "$ALL_CANDIDATES" | grep -iE "\.app\.tar\.gz$|\.zip$|\.msi$" | head -n 1)
          
          if [ -z "$BUNDLE_PATH" ]; then
             # 如果还没找到，尝试任何安装包作为保底
             BUNDLE_PATH=$(echo "$ALL_CANDIDATES" | grep -iE "\.dmg$|\.deb$|\.AppImage$|\.tar\.gz$" | head -n 1)
          fi
          
          if [ -z "$BUNDLE_PATH" ]; then
             echo "Error: Could not find any suitable bundle file for updater."
             echo "Listing src-tauri/target recursively for diagnostic:"
             ls -R src-tauri/target || true
             exit 1
          fi
          
          echo "Selected bundle: $BUNDLE_PATH"
          SIG_PATH="$BUNDLE_PATH.sig"
          
          # 4. 检查签名并生成 JSON
          if [ -f "$SIG_PATH" ]; then
            SIGNATURE=$(cat "$SIG_PATH")
            FILENAME=$(basename "$BUNDLE_PATH")
            DOWNLOAD_URL="https://github.com/lbjlaq/Antigravity-Manager/releases/download/$VERSION/$FILENAME"
            
            mkdir -p updater_fragments
            cat <<EOF > updater_fragments/fragment.json
            {
              "version": "$VERSION_CLEAN",
              "notes": "Update to $VERSION",
              "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "platforms": {
                "$ARCH": {
                  "signature": "$SIGNATURE",
                  "url": "$DOWNLOAD_URL"
                }
              }
            }
          EOF
            echo "Successfully generated fragment for $ARCH"
            cat updater_fragments/fragment.json
          else
            echo "Error: Signature file not found at $SIG_PATH"
            # 列出相关目录文件辅助诊断
            ls -la "$(dirname "$BUNDLE_PATH")"
            exit 1
          fi

      # 2. 上传 updater.json 碎片到 Artifacts
      - name: Upload updater json
        uses: actions/upload-artifact@v4
        if: matrix.platform == 'macos-latest' || matrix.platform == 'windows-latest'
        with:
          name: updater-json-${{ matrix.platform }}-${{ strategy.job-index }}
          path: updater_fragments/*.json
          if-no-files-found: ignore

      # 2. 直接上传安装包到 GitHub Release (避免 artifact 下载超时)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "Antigravity Tools ${{ github.ref_name }}"
          body: "See the assets to download this version and install."
          draft: false
          prerelease: false
          files: |
            src-tauri/target/**/release/bundle/**/*.dmg
            src-tauri/target/**/release/bundle/**/*.deb
            src-tauri/target/**/release/bundle/**/*.AppImage
            src-tauri/target/**/release/bundle/**/*.msi
            src-tauri/target/**/release/bundle/**/*.exe
            src-tauri/target/**/release/bundle/**/*.rpm
            src-tauri/target/**/release/bundle/**/*.app.tar.gz
            src-tauri/target/**/release/bundle/**/*.app.tar.gz.sig
            src-tauri/target/**/release/bundle/**/*.sig

  publish-release:
    needs: build-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 只下载 updater.json 相关的小文件
      - name: Download updater artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: updater-json-*
          path: all-updaters
          merge-multiple: true

      - name: Extract Release Notes
        run: |
          VERSION="${{ github.ref_name }}"
          echo "Extracting release notes for version $VERSION"
          
          # Extract the section, remove leading 4 spaces dedent
          awk -v ver="$VERSION" '
            BEGIN { capture=0 }
            # Match start line: "    *   **v4.1.0..."
            $0 ~ "^[[:space:]]*\\*[[:space:]]+\\*\\*" ver { capture=1; next }
            # Match next version line to stop: "    *   **v..."
            capture && $0 ~ "^[[:space:]]*\\*[[:space:]]+\\*\\*v" { capture=0; exit }
            capture { print }
          ' README.md | sed 's/^    //' > release_notes.md
          
          # If no notes found, add a default message
          if [ ! -s release_notes.md ]; then
            echo "See the assets to download this version and install." > release_notes.md
          fi
          
          echo "Release Notes Content:"
          cat release_notes.md

      - name: Merge updater JSONs
        run: |
          echo "Merging updater.json files..."
          echo "{}" > merged_updater.json
          
          # 查找所有下载下来的 json 并合并
          find all-updaters -name "*.json" -type f | while read json_file; do
            echo "Processing $json_file..."
            jq -s '.[0] * .[1]' merged_updater.json "$json_file" > temp.json && mv temp.json merged_updater.json
          done
          
          echo "Merged JSON content:"
          cat merged_updater.json
          
          mv merged_updater.json updater.json

      - name: Upload merged updater.json
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: updater.json
          # 确保不覆盖已存在的其他 assets (softprops/action-gh-release 默认是追加)

  docker-build-amd64:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && (github.repository == 'lbjlaq/Antigravity-Manager' || vars.ENABLE_DOCKER_PUSH == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (AMD64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ github.repository_owner }}/antigravity-manager:latest-amd64
            ${{ github.repository_owner }}/antigravity-manager:${{ github.ref_name }}-amd64
          build-args: |
            USE_MIRROR=false

  docker-build-arm64:
    runs-on: ubuntu-24.04-arm
    if: github.event_name != 'pull_request' && (github.repository == 'lbjlaq/Antigravity-Manager' || vars.ENABLE_DOCKER_PUSH == 'true')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (ARM64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/arm64
          push: true
          tags: |
            ${{ github.repository_owner }}/antigravity-manager:latest-arm64
            ${{ github.repository_owner }}/antigravity-manager:${{ github.ref_name }}-arm64
          build-args: |
            USE_MIRROR=false

  docker-manifest:
    needs: [docker-build-amd64, docker-build-arm64]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && (github.repository == 'lbjlaq/Antigravity-Manager' || vars.ENABLE_DOCKER_PUSH == 'true')
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          docker buildx imagetools create -t ${{ github.repository_owner }}/antigravity-manager:latest \
            ${{ github.repository_owner }}/antigravity-manager:latest-amd64 \
            ${{ github.repository_owner }}/antigravity-manager:latest-arm64

          docker buildx imagetools create -t ${{ github.repository_owner }}/antigravity-manager:${{ github.ref_name }} \
            ${{ github.repository_owner }}/antigravity-manager:${{ github.ref_name }}-amd64 \
            ${{ github.repository_owner }}/antigravity-manager:${{ github.ref_name }}-arm64
